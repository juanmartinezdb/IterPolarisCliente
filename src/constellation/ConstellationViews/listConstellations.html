<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>listado constelaciones</title>
  <link rel="shortcut icon" href="../../../assets/logo.jpg" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <!-- mapas -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="../../../css/main.css">

  <!-- SCRIPTS  del cargador-->
  <script src="../../fragments/js/charger.js"></script>
</head>

<body>
  <div class="mainnavbar"></div>

  <div class="d-flex row">

    <div class="lateral container-fluid col-md-3 col-lg-2 py-2">

    </div>

    <div class="main-content col-md-9 p-4">
      <!-- Cabecera -->
      <div class="d-flex col-md-10 justify-content-between align-items-end mb-4">
        <div class="d-flex">
          <h2 class="me-2 nombre"> Nombre</h2>
          <img class="logo imagen" src="../../../assets/logo.jpg" alt="Imagen proyecto">
        </div>
        <div>
          <button class="btn btn-warning"><i class="bi bi-pencil-fill"></i></button>
          <button class="btn btn-danger"><a class="text-white" href="#"><i class="bi bi-x-lg"></i></a></button>
        </div>
      </div>

      <!-- Contenido y mapa -->
      <div class="row">
        <div class="col-md-6">
          <p><strong>Status:</strong> <span class="activa">Activa</span></p>
          <h4 class="galaxia">Proyecto de Clase</h4>
          <p class="descripcion">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Et expedita sint debitis labore ipsa accusantium.
          </p>
        </div>
        <div class="col-md-4">
          <div id="map"></div>
        </div>
      </div>

      <!-- Estrellas -->
      <div class="mt-4">
        <h4>Estrellas <i class="bi bi-stars"></i></h4>
        <div class="row">
          <div class="col-md-4">
            <div class="p-3 border">
              <h5><i class="bi bi-check2-circle"></i> Hábitos:</h5>
              <ul class="list-unstyled habitos"></ul>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3 border">
              <h5><i class="bi bi-calendar2-heart"></i> Tareas:</h5>
              <ul class="list-unstyled tareas"></ul>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3 border">
              <h5><i class="bi bi-bookmark-star"></i> Recursos:</h5>
              <ul class="list-unstyled recursos"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>


  <script type="module"> //SI NO ES MODULE NO CARGA LOS IMPORTS!
    import { loadC, getC } from '../../fragments/js/jsonCRUD.js';

    window.addEventListener("DOMContentLoaded", async () => {
      // Cargar plantillas y esperar a que se carguen
      await chargeTemplate("../../fragments/html/navbar.html", ".mainnavbar");
      await chargeTemplate("../../fragments/html/lateralConstellation.html", ".lateral");

      //Cargar el array de constelaciones
      await loadC();
      const c = getC();
      console.log(c);

      const displayStar = (e) => {
        const idC = e.target.dataset.idC;
        const id = e.target.dataset.id;
      }


      //PINTAR CONSTELACION
      const displayConstellation = (conste) => {
        document.querySelector(".nombre").textContent = conste.nombre;
        document.querySelector(".activa").textContent = conste.activa;
        document.querySelector(".galaxia").textContent = conste.galaxia;
        document.querySelector(".descripcion").textContent = conste.descripcion;
        document.querySelector(".imagen").src = conste.imagen;

        // Limpiar contenido anterior
        document.querySelectorAll('.habitos, .tareas, .recursos').forEach(ul => ul.innerHTML = '');

        const tipoToClass = {
          'Hábito': 'habitos',
          'Tarea': 'tareas',
          'Recurso': 'recursos'
        };

        conste.estrellas.forEach(estrella => {
          const tipoClase = tipoToClass[estrella.tipo];
          const ul = document.querySelector("." + tipoClase);
          if (ul) {
            const li = document.createElement("li");
            const enlace = document.createElement("a");
            ul.appendChild(li);
            li.appendChild(enlace);
            enlace.dataset.idC = estrella.idConstelacion;
            enlace.dataset.id = estrella.id;
            enlace.textContent = estrella.nombre;
            enlace.href = "../../star/listStars.html";
            //SI PINCHO MOSTRAR LA ESTRELLA
            enlace.addEventListener("click", displayStar);
          } else {
            console.error('No se encontró la lista para el tipo:', estrella.tipo);
          }
        });
      }

      // ABRIR  UNA CONSTELACION 
      const launchConstellation = (id) => {
        id = parseInt(id); // Convertir id a número
        const conste = c.find(c => c.id === id);
        if (conste) {
          displayConstellation(conste); // Llamar a la función para pintar la constelación
        } else {
          console.error("Constelación no encontrada con ID:", id);
        }

      }
      //CONSTRUIR BARRA LATERAL y MARCAR
      const itemLateral = (constelation) => {
        let li = document.createElement("li");
        let enlace = document.createElement("a");
        li.appendChild(enlace);
        li.classList.add("list-group-item", "list-group-item-action");
        enlace.textContent = constelation.nombre;
        // enlace.href = "listConstellations.html";
        li.dataset.id = constelation.id;
        document.querySelector("." + constelation.galaxia).appendChild(li);

        // Añadir event listener aquí
        li.addEventListener('click', () => {
          // Remover clase 'active' de todos los items
          const listaItems = document.querySelectorAll('.list-group-item');
          listaItems.forEach(i => i.classList.remove('active'));

          li.classList.add('active');
          launchConstellation(li.dataset.id);
        });
      }
      c.forEach(constellation => {
        itemLateral(constellation);
        // const listaItems = document.querySelectorAll('.list-group-item');
        // listaItems.forEach(constellation => {
        //   constellation.addEventListener('click', () => {
        //     listaItems.forEach(i => i.classList.remove('active'));
        //     constellation.classList.add('active');
        //     launchConstellation(constellation.dataset.id);
        //   });
        // });
      });

      // Cargar la primera constelación por defecto y marcarla como activa
      if (c.length > 0) {
        launchConstellation(c[0].id);
        document.querySelector(`.list-group-item[data-id="${c[0].id}"]`).classList.add('active');
      }

    });
  </script>
  <script>
    // MOSTRAR MAPA -----------------------(coordenada original el instituto)
    // Crear el mapa centrado en las coordenadas iniciales
    const initialCoordinates = [36.6957750088756, 355.54315547233134]; // Tus coordenadas originales
    const map = L.map('map').setView(initialCoordinates, 20);

    // Añadir capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
    }).addTo(map);

    // Agregar marcador inicial
    let marker = L.marker(initialCoordinates, { draggable: true }).addTo(map)
      .bindPopup('Haz clic para moverme a otra ubicación')
      .openPopup();
    // ------------------------------------------------------------------------------

  </script>
</body>

</html>
